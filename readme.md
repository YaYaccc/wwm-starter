# 燕云十六声启动优化器

## 0. 前提概要与使用指南

**背景**：
NVIDIA App 目前尚未适配《燕云十六声》国服环境，仅适配了外服环境。通过修改国服启动程序名称，可以“欺骗”驱动从而享受到 DLSS 4.5 等优化技术。但由于游戏更新会导致启动器文件变化，且 N 卡识别的文件名与原文件名不一致，每次更新都需要手动重新复制并重命名文件。本项目旨在自动化这一繁琐过程。

**全操作流程**：
1.  将构建好的 `wwm-starter.exe` 放入游戏二进制目录（默认为 `yysls_medium\Engine\Binaries\Win64r`）。
2.  运行本程序，游戏启动后关闭游戏。
3.  打开 NVIDIA App，将燕云游戏安装文件夹添加至扫描路径，并配置相关优化信息。
4.  再次运行本程序，之后即可享受优化待遇。

**游戏更新流程**：
1.  手动启动原本的游戏启动器（Launcher），更新游戏。
2.  更新完成并成功进入游戏后，关闭游戏。
3.  运行 `wwm-starter.exe`，它会自动检测并替换旧版的 `wwm.exe` 文件，确保版本一致。

---

## 1. 项目概述

本工具的主要功能是管理并启动 `wwm.exe` 进程。在启动前，它会确保 `wwm.exe` 与源文件 `yysls.exe` 保持一致（如果不存在则创建，如果版本不一致则更新）。

**重要提示**：本程序不能命名为 `yysls.exe`，否则会覆盖游戏原文件，导致游戏损坏。建议使用默认名称 `wwm-starter.exe`。

## 2. 配置与环境

*   **部署位置**：
    *   本程序设计为放置在游戏/引擎的二进制目录下运行。
    *   默认路径：`yysls_medium\Engine\Binaries\Win64r`（程序直接读取自身所在目录，不依赖绝对路径或环境变量）。
*   **权限要求**：
    *   **必须以管理员权限运行**。
    *   程序内置了自动请求提升权限（UAC）的逻辑。如果用户以普通权限启动，程序会自动请求管理员权限重启自身。

## 3. 文件路径定义

所有路径均基于**程序当前所在目录**（记为 `%CURRENT_DIR%`）。

*   **源文件 (Source)**：`%CURRENT_DIR%\yysls.exe`
*   **目标文件 (Target)**：`%CURRENT_DIR%\wwm.exe`

## 4. 核心业务逻辑

程序启动后，应严格按照以下步骤执行：

1.  **权限检查**：
    *   程序启动时首先检查当前是否拥有管理员权限。
    *   **若无权限**：尝试以 `runas` 方式重启自身，请求用户批准 UAC。
    *   **若有权限**：继续执行后续步骤。

2.  **环境初始化**：
    *   获取当前执行文件所在的目录。
    *   以此目录为基准构建源文件和目标文件路径。

3.  **文件同步检查**：
    *   **检查源文件**：确认 `yysls.exe` 是否存在。若不存在，视为严重错误，终止流程并报错。
    *   **检查目标文件** (`wwm.exe`)：
        *   **情况 A：文件不存在**
            *   执行操作：将 `yysls.exe` 复制为 `wwm.exe`。
        *   **情况 B：文件已存在**
            *   执行操作：检查 `yysls.exe` 与 `wwm.exe` 的版本/内容一致性（SHA256）。
            *   **若不一致**：
                1.  删除旧的 `wwm.exe`。
                2.  将 `yysls.exe` 复制为 `wwm.exe`。
            *   **若一致**：跳过复制步骤。

4.  **启动进程**：
    *   上述检查与同步完成后，启动 `wwm.exe`。
    *   **不输出日志**：不绑定子进程的标准输出和错误输出，保持静默。
    *   **自动退出**：启动成功提示后，等待 2 秒自动关闭启动器，不等待子进程结束。

## 5. 异常处理

程序在运行过程中遇到任何阻断性问题，必须向用户提供清晰的反馈：

*   **路径错误**：
    *   触发条件：源文件 `yysls.exe` 在当前目录下缺失。
    *   处理方式：提示用户检查文件路径是否正确。
*   **权限问题**：
    *   触发条件：文件复制失败、文件删除失败或进程启动失败（通常由权限不足或文件被占用导致）。
    *   处理方式：提示用户检查文件权限，或尝试以管理员身份运行。

## 6. 构建与部署

*   **构建脚本**：项目根目录下提供了 `build.bat` 脚本。
    *   该脚本会自动安装 `rsrc` 工具（用于嵌入图标）。
    *   自动将 `resource\favicon.ico` 嵌入到 `yysls.exe` 中。
    *   执行 `go build` 生成最终的可执行文件。
*   **依赖**：构建需要 Go 环境，并联网下载 `rsrc` 工具（首次运行时）。
